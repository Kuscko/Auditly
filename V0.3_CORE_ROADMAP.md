# v0.3 Core Functionality Roadmap

## Focus: Core Engine Before User Interface

This phase prioritizes building robust core functionality over user-facing features like REST APIs and dashboards. The goal is to create a solid foundation for evidence collection, validation, and persistence.

---

## Phase 3A: Evidence Collection Expansion (Weeks 5-8)

### AWS Collector (Priority 1)
**Goal**: Comprehensive AWS evidence collection for FedRAMP/NIST compliance

**Components**:
- [ ] **IAM Evidence**: Users, roles, policies, MFA status, password policies
- [ ] **EC2 Evidence**: Instance configs, security groups, EBS encryption, snapshots
- [ ] **S3 Evidence**: Bucket policies, encryption, versioning, access logs
- [ ] **CloudTrail**: Event history, management events, data events
- [ ] **Config**: Resource configuration history, compliance rules
- [ ] **VPC Evidence**: Flow logs, network ACLs, route tables, NAT gateways
- [ ] **RDS Evidence**: Instance configs, encryption, backup retention, parameter groups
- [ ] **Secrets Manager**: Secret rotation policies, encryption keys
- [ ] **KMS**: Key policies, rotation status, usage audit

**Implementation**:
```python
rapidrmf/collectors/aws/
├── __init__.py
├── client.py          # Boto3 session management
├── iam.py             # IAM evidence collector
├── ec2.py             # EC2 evidence collector
├── s3.py              # S3 evidence collector
├── cloudtrail.py      # CloudTrail evidence
├── vpc.py             # VPC/networking evidence
├── rds.py             # RDS evidence
└── README.md
```

**CLI**:
```bash
rapidrmf collect aws \
  --config config.yaml \
  --env production \
  --services iam,ec2,s3,cloudtrail
```

### GCP Collector (Priority 2)
**Goal**: Google Cloud evidence for multi-cloud environments

**Components**:
- [ ] **IAM**: Service accounts, roles, policies, org policies
- [ ] **Compute Engine**: Instance configs, firewall rules, disk encryption
- [ ] **Cloud Storage**: Bucket policies, encryption, retention
- [ ] **Cloud SQL**: Instance configs, backup policies, SSL enforcement
- [ ] **Cloud Logging**: Audit logs, admin activity, data access
- [ ] **VPC**: Network topology, firewall rules, Cloud NAT

**Implementation**:
```python
rapidrmf/collectors/gcp/
├── __init__.py
├── client.py          # Google Cloud client
├── iam.py
├── compute.py
├── storage.py
├── sql.py
└── README.md
```

### Azure Collector Enhancements (Priority 3)
**Goal**: Expand existing Azure collector with missing services

**Components**:
- [ ] **Azure SQL Database**: Firewall rules, TDE, auditing
- [ ] **Key Vault**: Key policies, rotation, secret management
- [ ] **Azure Monitor**: Activity logs, diagnostic settings
- [ ] **Azure AD**: Conditional access, MFA, identity protection
- [ ] **Network Security Groups**: Rule analysis, flow logs

---

## Phase 3B: Evidence Lifecycle Management (Weeks 9-10)

### Evidence Versioning & History
- [ ] Track evidence changes over time (who, what, when)
- [ ] Store evidence snapshots for historical compliance queries
- [ ] Compare current vs previous evidence to detect drift

### Staleness Detection
- [ ] Auto-flag evidence older than threshold (e.g., IAM > 30 days)
- [ ] Configurable staleness rules per evidence type
- [ ] Alert on stale evidence affecting active controls

### Evidence Correlation & Deduplication
- [ ] Detect duplicate evidence from multiple collection runs
- [ ] Cross-system correlation (same user in AWS + Azure + AD)
- [ ] Link related evidence (EC2 instance → security group → VPC)

### Chain of Custody
- [ ] Digital signatures on evidence records (Ed25519)
- [ ] Audit trail of who accessed/modified evidence
- [ ] Tamper detection via checksums and DB constraints

**Database Schema**:
```sql
-- Evidence versions table
CREATE TABLE evidence_versions (
    id SERIAL PRIMARY KEY,
    evidence_id INT REFERENCES evidence(id),
    version INT NOT NULL,
    data JSONB NOT NULL,
    collected_at TIMESTAMP NOT NULL,
    collector_version TEXT,
    signature TEXT,
    UNIQUE(evidence_id, version)
);

-- Evidence access log
CREATE TABLE evidence_access_log (
    id SERIAL PRIMARY KEY,
    evidence_id INT REFERENCES evidence(id),
    user_id TEXT NOT NULL,
    action TEXT NOT NULL,  -- read, update, delete
    timestamp TIMESTAMP DEFAULT NOW(),
    ip_address TEXT
);
```

---

## Phase 3C: Advanced Validation Engine (Weeks 11-12)

### Control Dependencies
- [ ] Define prerequisite controls (AC-2 requires AC-1)
- [ ] Validate dependencies before dependent controls
- [ ] Skip dependent controls if prerequisites fail

### Control Inheritance
- [ ] Map cloud provider inherited controls (FedRAMP, ISO)
- [ ] Track which controls are customer vs provider responsibility
- [ ] Auto-mark inherited controls as satisfied with provider evidence

### Custom Validators
- [ ] Policy-as-code framework (extend existing Conftest/OPA)
- [ ] Custom validator registration system
- [ ] Python-based validator SDK

**Example Custom Validator**:
```python
from rapidrmf.validators import BaseValidator, ValidationResult, ValidationStatus

class CustomIAMValidator(BaseValidator):
    control_id = "AC-2"
    
    async def validate(self, evidence: dict, metadata: dict) -> ValidationResult:
        # Custom validation logic
        users = evidence.get("iam", {}).get("users", [])
        mfa_enabled = all(u.get("mfa_enabled") for u in users)
        
        return ValidationResult(
            status=ValidationStatus.PASS if mfa_enabled else ValidationStatus.FAIL,
            message="All users have MFA" if mfa_enabled else "Some users lack MFA",
            evidence_keys=[f"iam:users:{u['username']}" for u in users]
        )
```

### Findings Management
- [ ] Finding lifecycle: Open → Investigating → Remediating → Closed
- [ ] Assign findings to owners with due dates
- [ ] Link findings to evidence and controls
- [ ] Track remediation progress

**Database Schema**:
```sql
-- Enhanced findings table
ALTER TABLE findings ADD COLUMN owner TEXT;
ALTER TABLE findings ADD COLUMN due_date TIMESTAMP;
ALTER TABLE findings ADD COLUMN remediation_notes TEXT;
ALTER TABLE findings ADD COLUMN remediation_evidence JSONB;
```

---

## Phase 3D: Performance & Optimization (Week 13)

### Evidence Caching
- [ ] Redis cache for frequently-accessed evidence
- [ ] Cache invalidation on new evidence collection
- [ ] TTL-based cache expiry per evidence type

### Parallel Collection
- [ ] Concurrent evidence collection across AWS services
- [ ] Thread pool for multi-account/multi-region collection
- [ ] Rate limiting and backoff for API throttling

### Incremental Validation
- [ ] Only re-validate controls affected by new evidence
- [ ] Dependency graph to track control → evidence relationships
- [ ] Skip unchanged evidence in validation runs

---

## Deferred Features (Post-v0.3)

These user-facing features are valuable but not core functionality:

### Deferred to v0.4+
- REST API endpoints (already built, but not prioritized)
- Web dashboard and UI
- Interactive reports with filtering/search
- Slack/Teams notifications
- CI/CD webhook integrations

### Why Defer?
- Core engine must be rock-solid before exposing via APIs
- Evidence collection and validation are the foundation
- User interfaces can be rapidly built once core is stable
- APIs can change based on core functionality needs

---

## Success Metrics for v0.3

- **Evidence Coverage**: Collect 90% of controls' required evidence from AWS/GCP/Azure
- **Validation Accuracy**: 95%+ precision on control pass/fail determinations
- **Performance**: Collect + validate 1000 controls in < 5 minutes
- **Data Quality**: 100% evidence with chain of custody and signatures
- **Staleness**: No evidence older than 30 days for critical controls

---

## Implementation Timeline

| Week | Focus | Deliverable |
|------|-------|-------------|
| 5-6 | AWS Collector | IAM, EC2, S3, CloudTrail evidence |
| 7 | GCP Collector | Compute, Storage, IAM evidence |
| 8 | Azure Enhancements | Key Vault, SQL, Monitor evidence |
| 9-10 | Evidence Lifecycle | Versioning, staleness, correlation |
| 11-12 | Advanced Validation | Dependencies, custom validators, findings |
| 13 | Performance | Caching, parallel collection, optimization |

---

## Next Steps

1. Review and approve this roadmap
2. Set up AWS test account for development
3. Begin AWS IAM collector implementation
4. Create integration tests for AWS evidence collection
5. Document evidence schemas for each cloud provider
